{% if groups[instance_group] | d([]) | length > 0 %}
all:
  vars:
    ansible_user: "{{ vm_user }}"
    ansible_ssh_private_key_file: "{{ sshkeys_priv_file }}"
    ansible_ssh_common_args: "{{ ansible_ssh_common_args }}"
    
  children:
{% for grp in instance_role_groups %}
{% if groups[grp] | d([]) | length > 0 %}
    new{{grp}}:
      hosts:
{% for host in groups[instance_group] %}
{% if not host in vm_skip_list %}
{% if (( '-' in host and host.split('-')[1]) or (not '-' in host)) | regex_replace('\\d','') in grp %}
        {{ host }}: 
          ansible_host: {{ hostvars[host]['ansible_host'] }} 
{% if hostvars[host]['additional_disks'] | d ([]) | length > 0 %}
          additional_disks: 
            {{ hostvars[host]['additional_disks'] | d ([]) | to_yaml | indent(12) }}
{% else %}
          additional_disks: {{ hostvars[host]['additional_disks'] | d ([]) }}
{% endif %}
{% elif host in grp %}
        {{ host }}: 
          ansible_host: {{ hostvars[host]['ansible_host'] }} 
{% if hostvars[host]['additional_disks'] | d ([]) | length > 0 %}
          additional_disks: 
            {{ hostvars[host]['additional_disks'] | d ([]) | to_yaml | indent(12) }}
{% else %}
          additional_disks: {{ hostvars[host]['additional_disks'] | d ([]) }}
{% endif %}

{% endif %}
{% endif %}
{% endfor %}
{% endif %}
{% endfor %}
{% endif %}
